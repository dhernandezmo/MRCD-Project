---
title: "Simulación 2 y 4"
author: "Anni Velandia"
date: "11/11/2022"
output: pdf_document
---

```{r Librerías, message=FALSE, warning=FALSE}
library(MVN)
library(MASS)
library(Matrix) #Crea matriz bloque diagonal
library(dplyr)
library(caret) #Crear matrix de confusion

```

# Diseño 4 de simulación

Los siguientes diseños de simulación están creados para comparar los métodos de simulación RSIMCA y QDA como métodos de clasificación robusta para datos de alta dimensionalidad con diferentes matrices en cada población.


# Segundo diseño de simulación
## Definición de los parámetros de las poblaciones

# Segundo diseño de simulación
## Definición de los parámetros de las poblaciones
```{r Parámetros de tamaño}
N = c(50, 50, 50,50,50)
p=c(50,100,200,500,1000)
```

```{r Vector de medias}
#Población A
mA_1 = matrix(c(3,3,3, rep(0,(p[1]-3))),nrow = p[1],  ncol = 1)
mA_2 = matrix(c(3,3,3, rep(0,(p[2]-3))),nrow = p[2],  ncol = 1)
mA_3 = matrix(c(3,3,3, rep(0,(p[3]-3))),nrow = p[3],  ncol = 1)
mA_4 = matrix(c(3,3,3, rep(0,(p[4]-3))),nrow = p[4],  ncol = 1)
mA_5 = matrix(c(3,3,3, rep(0,(p[5]-3))),nrow = p[5],  ncol = 1)

#Población B
mB_1 = matrix(c(rep(0,(p[1]))),nrow = p[1],  ncol = 1)
mB_2 = matrix(c(rep(0,(p[2]))),nrow = p[2],  ncol = 1)
mB_3 = matrix(c(rep(0,(p[3]))),nrow = p[3],  ncol = 1)
mB_4 = matrix(c(rep(0,(p[4]))),nrow = p[4],  ncol = 1)
mB_5 = matrix(c(rep(0,(p[5]))),nrow = p[5],  ncol = 1)
```


```{r Matrices de varianza y covarianza}
# BLOQUES
#Población A
Bloque_A1<-matrix(1/2,nrow=3,ncol=3);diag(Bloque_A1)<-2

#Población B
Bloque_B1<-Bloque_A1-diag(1,3)

#Bloque Conjunto A y B
Bloque_AB_1<-matrix(1/2,nrow=p[1]-3,ncol=p[1]-3);diag(Bloque_AB_1)<-1
Bloque_AB_2<-matrix(1/2,nrow=p[2]-3,ncol=p[2]-3);diag(Bloque_AB_2)<-1
Bloque_AB_3<-matrix(1/2,nrow=p[3]-3,ncol=p[3]-3);diag(Bloque_AB_3)<-1
Bloque_AB_4<-matrix(1/2,nrow=p[4]-3,ncol=p[4]-3);diag(Bloque_AB_3)<-1
Bloque_AB_5<-matrix(1/2,nrow=p[5]-3,ncol=p[5]-3);diag(Bloque_AB_3)<-1


#MATRICES (Sigma A y Sigma B)
#Población A
sA_1 <- bdiag(Bloque_A1,Bloque_AB_1)
sA_2 <- bdiag(Bloque_A1,Bloque_AB_2)
sA_3 <- bdiag(Bloque_A1,Bloque_AB_3)
sA_4 <- bdiag(Bloque_A1,Bloque_AB_4)
sA_5 <- bdiag(Bloque_A1,Bloque_AB_5)

#Población B
sB_1 <- bdiag(Bloque_B1,Bloque_AB_1)
sB_2 <- bdiag(Bloque_B1,Bloque_AB_2)
sB_3 <- bdiag(Bloque_B1,Bloque_AB_3)
sB_4 <- bdiag(Bloque_B1,Bloque_AB_4)
sB_5 <- bdiag(Bloque_B1,Bloque_AB_5)



```


## Simulación primer tamaño 
```{r}

BIG_4_error_mrcd_1=NULL
BIG_4_error_rsimca_1=NULL
BIG_4_confusion_mrcd_1=NULL 
BIG_4_confusion_rsimca_1=NULL 

BIG_4_error_test_mrcd_1=NULL
BIG_4_error_test_rsimca_1=NULL
BIG_4_confusion_test_mrcd_1=NULL 
BIG_4_confusion_test_rsimca_1=NULL 

S=100
ncat <- floor (S/100)

#Datos contaminados
N_c = N*0.10
mC_c = matrix(rep(0,(p[1])),nrow = p[1],  ncol = 1)
SC_c = diag(1 ,nrow = p[1], ncol = p[1])


for (i in 1:S) {
# -------- MUESTRAS
SampleA_11 <- mvrnorm(N[1]*0.90,mA_1, sA_1) 
ContaminacionA_1 <- mvrnorm(N_c[1],mC_c, SC_c) 
SampleB_11 <- mvrnorm(N[1]*0.90,mB_1, sB_1)
ContaminacionB_1 <- mvrnorm(N_c[1],mC_c, SC_c) 

SampleA_1 <- rbind(SampleA_11,ContaminacionA_1)
SampleB_1 <- rbind(SampleB_11,ContaminacionB_1)


#Asignación de labels
LabelsA_1 <- c(rep(1,N[1]))
SampleA_1 <- cbind(SampleA_1, LabelsA_1)

LabelsB_1 <- c(rep(2,N[1]))
SampleB_1 <- cbind(SampleB_1, LabelsB_1)

#Data Union
Training_data_1 <- as.data.frame(rbind(SampleA_1, SampleB_1))
names(Training_data_1)[(p[1]+1)]<-"y1"

# -------- CLASIFICACION
#MRCD
MRCD_Test_1 <- Linda(y1~., data=Training_data_1, method="mrcd")
Confusion_matrix_mrcd <- predict(MRCD_Test_1)@ct/N[1]

T_error_mrcd <- (Confusion_matrix_mrcd[1,2]+Confusion_matrix_mrcd[2,1])/2
Confusion_vector_mrcd<- as.vector(Confusion_matrix_mrcd)

#RSIMCA
RSIMCA_Test_1 <- RSimca(y1~., data=Training_data_1)
Confusion_matrix_rsimca <- predict(RSIMCA_Test_1)@ct/N[1]

T_error_rsimca <- (Confusion_matrix_rsimca[1,2]+Confusion_matrix_rsimca[2,1])/2
Confusion_vector_rsimca<- as.vector(Confusion_matrix_rsimca)

# -------- GUARDAR B ITERACIONES
#MRCD
BIG_4_error_mrcd_1<- rbind(BIG_4_error_mrcd_1, T_error_mrcd)
BIG_4_confusion_mrcd_1<-rbind(BIG_4_confusion_mrcd_1,Confusion_vector_mrcd)

#RSIMCA
BIG_4_error_rsimca_1<- rbind(BIG_4_error_rsimca_1, T_error_rsimca)
BIG_4_confusion_rsimca_1<-rbind(BIG_4_confusion_rsimca_1,Confusion_vector_rsimca)

# --------  CONJUNTO DE VALIDACION 
#Generación de muestras 
SampleA_test_1 <- mvrnorm(N[1]/5,mA_1, sA_1) 
SampleB_test_1 <- mvrnorm(N[1]/5,mB_1, sB_1)

#Asignación de labels
LabelsA_test_1 <- c(rep(1,N[1]/5))
SampleA_test_1 <- cbind(SampleA_test_1, LabelsA_test_1)

LabelsB_test_1 <- c(rep(2,N[1]/5))
SampleB_test_1 <- cbind(SampleB_test_1, LabelsB_test_1)


#Data Union
Test_data_1 <- as.data.frame(rbind(SampleA_test_1, SampleB_test_1))
names(Test_data_1)[(p[1]+1)]<-"y1"

# -------- CLASIFICACION TEST DATA
#Predicción 
Levels_predict_mrcd_1 <-(predict(MRCD_Test_1, Test_data_1[,1:p[1]])@classification) 
Levels_predict_rsimca_1 <-(predict(RSIMCA_Test_1, Test_data_1[,1:p[1]])@classification)

#Original Levels
Levels_original_1<-as.factor(Test_data_1[,p[1]+1])

#Confusion Matrix for Test
CM_levels_mrcd_1<-confusionMatrix(Levels_predict_mrcd_1,Levels_original_1) 
CM_levels_rsimca_1<-confusionMatrix(Levels_predict_rsimca_1,Levels_original_1)

cbind(Levels_original_1,Levels_predict_mrcd_1,Levels_predict_rsimca_1)

#MRCD
Test_error_mrcd<- 1-CM_levels_mrcd_1$overall["Accuracy"]
Confusion_vector_test_mrcd_1 <- as.vector(CM_levels_mrcd_1$table/(N[1]/5))

#RSIMCA
Test_error_rsimca <- 1-CM_levels_rsimca_1$overall["Accuracy"]
Confusion_vector_test_rsimca_1 <- as.vector(CM_levels_rsimca_1$table/(N[1]/5))

# -------- GUARDAR B ITERACIONES DE TESTING
#MRCD Test
BIG_4_error_test_mrcd_1<- rbind(BIG_4_error_test_mrcd_1, Test_error_mrcd)
BIG_4_confusion_test_mrcd_1<-rbind(BIG_4_confusion_test_mrcd_1,Confusion_vector_test_mrcd_1)

#RSIMCA Test
BIG_4_error_test_rsimca_1<- rbind(BIG_4_error_test_rsimca_1, Test_error_rsimca)
BIG_4_confusion_test_rsimca_1<-rbind(BIG_4_confusion_test_rsimca_1,Confusion_vector_test_rsimca_1)

# Progreso
 if (i%%ncat == 0) cat(100*round(i/S, 2), "% completado ... \n", sep = "")
}


```

# Resultados
## Training validation
```{r}
Error_rate_mrcd_final_1<-mean(BIG_4_error_mrcd_1)
Error_rate_rsimca_final_1<-mean(BIG_4_error_rsimca_1)

#MATRICES FINALES
Confusion_matrix_mrcd_BIG_4_1 <- matrix(apply(BIG_4_confusion_mrcd_1,2,mean),2,2)
colnames(Confusion_matrix_mrcd_BIG_4_1)<-c("A","B")
rownames(Confusion_matrix_mrcd_BIG_4_1)<-c("A","B")

Confusion_matrix_rsimca_BIG_4_1 <- matrix(apply(BIG_4_confusion_rsimca_1,2,mean),2,2)
colnames(Confusion_matrix_rsimca_BIG_4_1)<-c("A","B")
rownames(Confusion_matrix_rsimca_BIG_4_1)<-c("A","B")
```

##Test validation 
```{r}
TEST_error_rate_mrcd_final_1<-mean(BIG_4_error_test_mrcd_1)
TEST_error_rate_rsimca_final_1<-mean(BIG_4_error_test_rsimca_1)

#MATRICES FINALES de validación
TEST_confusion_matrix_mrcd_BIG_4_1 <- matrix(apply(BIG_4_confusion_test_mrcd_1,2,mean),2,2)
colnames(TEST_confusion_matrix_mrcd_BIG_4_1)<-c("A","B")
rownames(TEST_confusion_matrix_mrcd_BIG_4_1)<-c("A","B")

TEST_confusion_matrix_rsimca_BIG_4_1 <- matrix(apply(BIG_4_confusion_test_rsimca_1,2,mean),2,2)
colnames(TEST_confusion_matrix_rsimca_BIG_4_1)<-c("A","B")
rownames(TEST_confusion_matrix_rsimca_BIG_4_1)<-c("A","B")
```


```{r}
save(BIG_4_error_mrcd_1
,BIG_4_error_rsimca_1
,BIG_4_confusion_mrcd_1
,BIG_4_confusion_rsimca_1
,BIG_4_error_test_mrcd_1
,BIG_4_error_test_rsimca_1
,BIG_4_confusion_test_mrcd_1
,BIG_4_confusion_test_rsimca_1, file  = "Simulation4_resultados_1.RData")
load("Simulation4_resultados_1.RData")
```


## Simulación segundo tamaño 
```{r}

BIG_4_error_mrcd_2=NULL
BIG_4_error_rsimca_2=NULL
BIG_4_confusion_mrcd_2=NULL 
BIG_4_confusion_rsimca_2=NULL 

BIG_4_error_test_mrcd_2=NULL
BIG_4_error_test_rsimca_2=NULL
BIG_4_confusion_test_mrcd_2=NULL 
BIG_4_confusion_test_rsimca_2=NULL 

S=100
ncat <- floor (S/100)

#Datos contaminados
N_c = N*0.10
mC_c = matrix(rep(0,(p[2])),nrow = p[2],  ncol = 1)
SC_c = diag(1 ,nrow = p[2], ncol = p[2])


for (i in 1:S) {
# -------- MUESTRAS
SampleA_21 <- mvrnorm(N[2]*0.90,mA_2, sA_2) 
ContaminacionA_2 <- mvrnorm(N_c[2],mC_c, SC_c) 
SampleB_21 <- mvrnorm(N[2]*0.90,mB_2, sB_2)
ContaminacionB_2 <- mvrnorm(N_c[2],mC_c, SC_c) 

SampleA_2 <- rbind(SampleA_21,ContaminacionA_2)
SampleB_2 <- rbind(SampleB_21,ContaminacionB_2)


#Asignación de labels
LabelsA_2 <- c(rep(1,N[2]))
SampleA_2 <- cbind(SampleA_2, LabelsA_2)

LabelsB_2 <- c(rep(2,N[2]))
SampleB_2 <- cbind(SampleB_2, LabelsB_2)

#Data Union
Training_data_2 <- as.data.frame(rbind(SampleA_2, SampleB_2))
names(Training_data_2)[(p[2]+1)]<-"y1"

# -------- CLASIFICACION
#MRCD
MRCD_Test_2 <- Linda(y1~., data=Training_data_2, method="mrcd")
Confusion_matrix_mrcd <- predict(MRCD_Test_2)@ct/N[2]

T_error_mrcd <- (Confusion_matrix_mrcd[1,2]+Confusion_matrix_mrcd[2,1])/2
Confusion_vector_mrcd<- as.vector(Confusion_matrix_mrcd)

#RSIMCA
RSIMCA_Test_2 <- RSimca(y1~., data=Training_data_2)
Confusion_matrix_rsimca <- predict(RSIMCA_Test_2)@ct/N[2]

T_error_rsimca <- (Confusion_matrix_rsimca[1,2]+Confusion_matrix_rsimca[2,1])/2
Confusion_vector_rsimca<- as.vector(Confusion_matrix_rsimca)

# -------- GUARDAR B ITERACIONES
#MRCD
BIG_4_error_mrcd_2<- rbind(BIG_4_error_mrcd_2, T_error_mrcd)
BIG_4_confusion_mrcd_2<-rbind(BIG_4_confusion_mrcd_2,Confusion_vector_mrcd)

#RSIMCA
BIG_4_error_rsimca_2<- rbind(BIG_4_error_rsimca_2, T_error_rsimca)
BIG_4_confusion_rsimca_2<-rbind(BIG_4_confusion_rsimca_2,Confusion_vector_rsimca)

# --------  CONJUNTO DE VALIDACION 
#Generación de muestras 
SampleA_test_2 <- mvrnorm(N[2]/5,mA_2, sA_2) 
SampleB_test_2 <- mvrnorm(N[2]/5,mB_2, sB_2)

#Asignación de labels
LabelsA_test_2 <- c(rep(1,N[2]/5))
SampleA_test_2 <- cbind(SampleA_test_2, LabelsA_test_2)

LabelsB_test_2 <- c(rep(2,N[2]/5))
SampleB_test_2 <- cbind(SampleB_test_2, LabelsB_test_2)


#Data Union
Test_data_2 <- as.data.frame(rbind(SampleA_test_2, SampleB_test_2))
names(Test_data_2)[(p[2]+1)]<-"y1"

# -------- CLASIFICACION TEST DATA
#Predicción 
Levels_predict_mrcd_2 <-(predict(MRCD_Test_2, Test_data_2[,1:p[2]])@classification) 
Levels_predict_rsimca_2 <-(predict(RSIMCA_Test_2, Test_data_2[,1:p[2]])@classification)

#Original Levels
Levels_original_2<-as.factor(Test_data_2[,p[2]+1])

#Confusion Matrix for Test
CM_levels_mrcd_2<-confusionMatrix(Levels_predict_mrcd_2,Levels_original_2) 
CM_levels_rsimca_2<-confusionMatrix(Levels_predict_rsimca_2,Levels_original_2)

cbind(Levels_original_2,Levels_predict_mrcd_2,Levels_predict_rsimca_2)

#MRCD
Test_error_mrcd<- 1-CM_levels_mrcd_2$overall["Accuracy"]
Confusion_vector_test_mrcd_2 <- as.vector(CM_levels_mrcd_2$table/(N[2]/5))

#RSIMCA
Test_error_rsimca <- 1-CM_levels_rsimca_2$overall["Accuracy"]
Confusion_vector_test_rsimca_2 <- as.vector(CM_levels_rsimca_2$table/(N[2]/5))

# -------- GUARDAR B ITERACIONES DE TESTING
#MRCD Test
BIG_4_error_test_mrcd_2<- rbind(BIG_4_error_test_mrcd_2, Test_error_mrcd)
BIG_4_confusion_test_mrcd_2<-rbind(BIG_4_confusion_test_mrcd_2,Confusion_vector_test_mrcd_2)

#RSIMCA Test
BIG_4_error_test_rsimca_2<- rbind(BIG_4_error_test_rsimca_2, Test_error_rsimca)
BIG_4_confusion_test_rsimca_2<-rbind(BIG_4_confusion_test_rsimca_2,Confusion_vector_test_rsimca_2)

# Progreso
 if (i%%ncat == 0) cat(100*round(i/S, 2), "% completado ... \n", sep = "")
}


```

# Resultados
## Training validation
```{r}
Error_rate_mrcd_final_2<-mean(BIG_4_error_mrcd_2)
Error_rate_rsimca_final_2<-mean(BIG_4_error_rsimca_2)

#MATRICES FINALES
Confusion_matrix_mrcd_BIG_4_2 <- matrix(apply(BIG_4_confusion_mrcd_2,2,mean),2,2)
colnames(Confusion_matrix_mrcd_BIG_4_2)<-c("A","B")
rownames(Confusion_matrix_mrcd_BIG_4_2)<-c("A","B")

Confusion_matrix_rsimca_BIG_4_2 <- matrix(apply(BIG_4_confusion_rsimca_2,2,mean),2,2)
colnames(Confusion_matrix_rsimca_BIG_4_2)<-c("A","B")
rownames(Confusion_matrix_rsimca_BIG_4_2)<-c("A","B")
```

##Test validation 
```{r}
TEST_error_rate_mrcd_final_2<-mean(BIG_4_error_test_mrcd_2)
TEST_error_rate_rsimca_final_2<-mean(BIG_4_error_test_rsimca_2)

#MATRICES FINALES de validación
TEST_confusion_matrix_mrcd_BIG_4_2 <- matrix(apply(BIG_4_confusion_test_mrcd_2,2,mean),2,2)
colnames(TEST_confusion_matrix_mrcd_BIG_4_2)<-c("A","B")
rownames(TEST_confusion_matrix_mrcd_BIG_4_2)<-c("A","B")

TEST_confusion_matrix_rsimca_BIG_4_2 <- matrix(apply(BIG_4_confusion_test_rsimca_2,2,mean),2,2)
colnames(TEST_confusion_matrix_rsimca_BIG_4_2)<-c("A","B")
rownames(TEST_confusion_matrix_rsimca_BIG_4_2)<-c("A","B")
```


```{r}
save(BIG_4_error_mrcd_2
,BIG_4_error_rsimca_2
,BIG_4_confusion_mrcd_2
,BIG_4_confusion_rsimca_2
,BIG_4_error_test_mrcd_2
,BIG_4_error_test_rsimca_2
,BIG_4_confusion_test_mrcd_2
,BIG_4_confusion_test_rsimca_2, file  = "Simulation4_resultados_2.RData")
load("Simulation4_resultados_2.RData")
```

